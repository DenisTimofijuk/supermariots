!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/dist/",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class s{updateProxy(t){throw new Error("Method not implemented.")}constructor(t=1/60){let e=0,i=0;this.updateProxy=s=>{for(e+=(s-i)/1500,e>1&&(e=1);e>t;)this.update(t),e-=t;i=s,this.enqueue()}}update(t){}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class n{constructor(){this.keyStates=new Map,this.keyMap=new Map}addMapping(t,e){this.keyMap.set(t,e)}handleEvent(t){const{code:e}=t;if(!this.keyMap.has(e))return;t.preventDefault();const i="keydown"===t.type?1:0;if(this.keyStates.get(e)!==i){this.keyStates.set(e,i);var s=this.keyMap.get(e);void 0!==s&&s(i)}}listenTo(t){["keydown","keyup"].forEach(e=>{t.addEventListener(e,t=>{this.handleEvent(t)})})}}class o{constructor(){this.grid=[]}forEach(t){this.grid.forEach((e,i)=>{e.forEach((e,s)=>{t(e,i,s)})})}set(t,e,i){this.grid[t]||(this.grid[t]=[]),this.grid[t][e]=i}get(t,e){const i=this.grid[t];if(i)return i[e]}}class a{constructor(t,e){this.set(t,e)}set(t,e){this.x=t,this.y=e}}class r{constructor(){this.pos=new a(0,0),this.size=new a(256,224)}}class l{constructor(t,e,i){this.image=t,this.height=null==i?0:i,this.width=null==e?0:e,this.tiles=new Map,this.animations=new Map}defineAnim(t,e){this.animations.set(t,e)}define(t,e,i,s,n){const o=[!1,!0].map(t=>{const o=document.createElement("canvas");o.width=s,o.height=n;var a=o.getContext("2d");return t&&(a.scale(-1,1),a.translate(-s,0)),a.drawImage(this.image,e,i,s,n,0,0,s,n),o});this.tiles.set(t,o)}defineTile(t,e,i){this.define(t,e*this.width,i*this.height,this.width,this.height)}draw(t,e,i,s,n=!1){const o=this.tiles.get(t);void 0!==o&&e.drawImage(o[n?1:0],i,s)}drawAnim(t,e,i,s,n){const o=this.animations.get(t);o&&this.drawTile(o(n),e,i,s)}drawTile(t,e,i,s){this.draw(t,e,i*this.width,s*this.height)}}function d(t){return new Promise(e=>{const i=new Image;i.addEventListener("load",()=>{e(i)}),i.src=t})}function c(t){return fetch(t).then(t=>t.json())}function h(t){return(e=`./json/sprites/${t}.json`,c(e)).then(t=>Promise.all([t,d(t.imageURL)])).then(([t,e])=>{var i=t,s=t;const n=new l(e,i.tileW,i.tileH);return void 0!==i.tiles&&i.tiles.forEach(t=>{n.defineTile(t.name,t.index[0],t.index[1])}),void 0!==s.frames&&s.frames.forEach(t=>{n.define(t.name,...t.rect)}),void 0!==i.animations&&i.animations.forEach(t=>{const e=(i=t.frames,s=t.frameLen,function(t){const e=Math.floor(t/s)%i.length;return i[e]});var i,s;n.defineAnim(t.name,e)}),n});var e}class u{constructor(){this.layers=[]}draw(t,e){this.layers.forEach(i=>{i(t,e)})}}class p{constructor(t,e,i){this.pos=t,this.size=e,this.offset=i}overlaps(t){return this.bottom>t.top&&this.top<t.bottom&&this.left<t.right&&this.right>t.left}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(t){this.pos.y=t-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(t){this.pos.y=t-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(t){this.pos.x=t-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(t){this.pos.x=t-(this.size.x+this.offset.x)}}const m={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),LEFT:Symbol("left"),RIGHT:Symbol("right")};class f{constructor(t){this.NAME=t,this.speed=0,this.tasks=[]}finalize(){this.tasks.forEach(t=>t()),this.tasks.length=0}queue(t){this.tasks.push(t)}collides(t,e){}obstruct(t,e,i){}update(t,e,i){}}class y{constructor(t){this.name=t||"",this.canCollide=!0,this.pos=new a(0,0),this.vel=new a(0,0),this.size=new a(0,0),this.offset=new a(0,0),this.bounds=new p(this.pos,this.size,this.offset),this.traits=[],this.lifeTime=0}draw(t){}finalize(){this.traits.forEach(t=>{t.finalize()})}collides(t){this.traits.forEach(e=>{e.collides(this,t)})}standBy(t){var e,i=this;e=Math.abs(t.x-this.pos.x)<366,void 0!==i.physics&&void 0!==i.physics.enabled&&(i.physics.enabled=e)}obstruct(t,e){this.traits.forEach(i=>{i.obstruct(this,t,e)})}addTrait(t){this.traits.push(t),this[t.NAME]=t}update(t,e){this.traits.forEach(i=>{i.update(this,t,e)}),this.lifeTime+=t}}class g{constructor(t,e=16){this.matrix=t,this.tileSize=e}toIndex(t){return Math.floor(t/this.tileSize)}toIndexRange(t,e){const i=Math.ceil(e/this.tileSize)*this.tileSize,s=[];let n=t;do{s.push(this.toIndex(n)),n+=this.tileSize}while(n<i);return s}getByIndex(t,e){const i=this.matrix.get(t,e);if(i){const s=t*this.tileSize,n=s+this.tileSize,o=e*this.tileSize;return{tile:i,x1:s,x2:n,y1:o,y2:o+this.tileSize}}}searchByPosition(t,e){return this.getByIndex(this.toIndex(t),this.toIndex(e))}searchByRange(t,e,i,s){const n=[];return this.toIndexRange(t,e).forEach(t=>{this.toIndexRange(i,s).forEach(e=>{const i=this.getByIndex(t,e);i&&n.push(i)})}),n}}class b{constructor(t){this.tiles=new g(t)}checkX(t){let e=0;if(t.vel.x>0)e=t.bounds.right;else{if(!(t.vel.x<0))return;e=t.bounds.left}this.tiles.searchByRange(e,e,t.bounds.top,t.bounds.bottom).forEach(e=>{"ground"===e.tile.type&&(t.vel.x>0?t.bounds.right>e.x1&&t.obstruct(m.RIGHT,e):t.vel.x<0&&t.bounds.left<e.x2&&t.obstruct(m.LEFT,e))})}checkY(t){let e=0;if(t.vel.y>0)e=t.bounds.bottom;else{if(!(t.vel.y<0))return;e=t.bounds.top}this.tiles.searchByRange(t.bounds.left,t.bounds.right,e,e).forEach(e=>{"ground"===e.tile.type&&(t.vel.y>0?t.bounds.bottom>e.y1&&t.obstruct(m.BOTTOM,e):t.vel.y<0&&t.bounds.top<e.y2&&t.obstruct(m.TOP,e))})}test(t){this.checkY(t)}}class v{constructor(t){this.entities=t}check(t){this.entities.forEach(e=>{t!==e&&t.bounds.overlaps(e.bounds)&&(t.collides(e),e.collides(t))})}}class w{constructor(t){this.entities=t}check(t){"mario"===t.name&&this.entities.forEach(e=>{t!==e&&e.standBy(t.pos)})}}class x{constructor(){this.gravity=1500,this.totalTime=0,this.comp=new u,this.entities=new Set,this.EntityCollider=new v(this.entities),this.entityStandBy=new w(this.entities)}backgrounds(t,e){throw new Error("Method not implemented.")}setCollisionGrid(t){this.tileColider=new b(t)}update(t){this.entities.forEach(e=>{e.update(t,this)}),this.entities.forEach(t=>{this.EntityCollider.check(t)}),this.entities.forEach(t=>{this.entityStandBy.check(t)}),this.entities.forEach(t=>{t.finalize()}),this.totalTime+=t}}function T(t,e,i){const s=new g(e),n=document.createElement("canvas");n.width=272,n.height=240;const o=n.getContext("2d");return function(a,r){const l=s.toIndex(r.size.x),d=s.toIndex(r.pos.x);!function(s,a){o.clearRect(0,0,n.width,n.height);for(let n=s;n<=a;++n){const a=e.grid[n];a&&a.forEach((e,a)=>{e.name&&i.animations.has(e.name)?i.drawAnim(e.name,o,n-s,a,t.totalTime):e.name&&i.drawTile(e.name,o,n-s,a)})}}(d,d+l),a.imageSmoothingEnabled=!1,a.drawImage(n,-r.pos.x%16,-r.pos.y)}}function k(t,e){const i=function(t,e){const i=new o;for(const{tile:s,x:n,y:o}of _(t,e))i.set(n,o,{type:s.type});return i}(t.layers.reduce((t,e)=>t.concat(e.tiles),[]),t.patterns);e.setCollisionGrid(i)}function E(t,e,i){t.layers.forEach(s=>{const n=function(t,e){const i=new o;for(const{tile:s,x:n,y:o}of _(t,e))i.set(n,o,{name:s.name});return i}(s.tiles,t.patterns),a=T(e,n,i);e.comp.layers.push(a)})}function S(t,e,i,s){const n=function(t,e=64,i=64){const s=document.createElement("canvas");s.width=e,s.height=i;const n=s.getContext("2d");return function(o,a){t.forEach(t=>{n.clearRect(0,0,e,i),t.draw(n),o.drawImage(s,t.pos.x-a.pos.x,t.pos.y-a.pos.y)})}}(e.entities);t.entities.forEach(({name:t,pos:[n,o]})=>{const a=(0,i[t])(s);a.pos.set(n,o),e.entities.add(a)}),e.comp.layers.push(n)}function M(t,e){return function(i){return(s=`./json/levels/${i}.json`,c(s)).then(t=>Promise.all([t,h(t.spriteSheet)])).then(([i,s])=>{const n=new x;return k(i,n),E(i,n,s),S(i,n,t,e),n});var s}}function*z(t,e,i,s){const n=t+e,o=i+s;for(let e=t;e<n;++e)for(let t=i;t<o;++t)yield{x:e,y:t}}function C(t){if(4===t.length){const[e,i,s,n]=t;return z(e,i,s,n)}if(2===t.length){const[e,i]=t;return z(e,1,i,1)}if(3===t.length){const[e,i,s]=t;return z(e,i,s,1)}return z(0,0,0,1)}function*I(t){for(const e of t)yield*C(e)}function*_(t,e){yield*function*t(i,s,n){for(const o of i)for(const{x:i,y:a}of I(o.ranges)){const r=i+s,l=a+n;if(void 0!==o.pattern){const i=e[o.pattern].tiles;yield*t(i,r,l)}else yield{tile:o,x:r,y:l}}}(t,0,0)}class A extends f{constructor(){super("jump"),this.ready=0,this.duration=.3,this.velocity=200,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.playJump=!1}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod}obstruct(t,e){e===m.BOTTOM?this.ready=1:e===m.TOP&&this.cancel()}cancel(){this.engageTime=0,this.requestTime=0}update(t,e){t.killable.dead?this.dead(t):(this.playJump=!1,this.requestTime>0&&(this.ready>0&&(this.engageTime=this.duration,this.requestTime=0,this.playJump=!0),this.requestTime-=e),this.engageTime>0&&(t.vel.y=-(this.velocity+Math.abs(t.vel.x)*this.speedBoost),this.engageTime-=e),this.ready--)}dead(t){t.vel.x=0}}class O extends f{constructor(){super("go"),this.dir=0,this.acceleration=600,this.distance=0,this.heading=1,this.dragFactor=L,this.deceleration=300}update(t,e){if(t.killable.dead)return void this.dead(t);const i=Math.abs(t.vel.x);if(0!==this.dir)t.vel.x+=this.acceleration*e*this.dir,t.jump&&(t.jump.falling,this.heading=this.dir);else if(0!==t.vel.x){const s=Math.min(i,this.deceleration*e);t.vel.x+=t.vel.x>0?-s:s}else this.distance=0;const s=this.dragFactor*t.vel.x*i;t.vel.x-=s,this.distance+=i*e}dead(t){t.vel.x=0}}class P extends f{constructor(){super("stomper"),this.bounceSpeed=200,this.playStomp=!1,this.cycleDellay=0}onStomp(t,e){}bounce(t,e){t.bounds.bottom=e.bounds.top,t.vel.y=-this.bounceSpeed}collides(t,e){e.killable&&!e.killable.dead&&t.vel.y>e.vel.y&&(this.bounce(t,e),this.onStomp(t,e),this.playStomp=!0)}update(t,e){this.cycleDellay>0&&(this.cycleDellay=0,this.playStomp=!1),this.playStomp&&0==this.cycleDellay&&this.cycleDellay++}}class j extends f{constructor(){super("killable"),this.dead=!1,this.deadTime=0,this.removeAfter=2}kill(){this.queue(()=>this.dead=!0)}revive(){this.dead=!1,this.deadTime=0}onScreenHandler(t){t>240&&this.kill(),t<-50&&this.kill()}update(t,e,i){this.dead&&(this.deadTime+=e,this.deadTime>this.removeAfter&&this.queue(()=>{i.entities.delete(t)}))}}class R extends f{constructor(){super("solid"),this.obstructs=!0}obstruct(t,e,i){this.obstructs&&(e===m.BOTTOM?(t.bounds.bottom=i.y1,t.vel.y=0):e===m.TOP?(t.bounds.top=i.y2,t.vel.y=0):e===m.LEFT?(t.bounds.left=i.x2,t.vel.x=0):e===m.RIGHT&&(t.bounds.right=i.x1,t.vel.x=0))}}class N extends f{constructor(){super("physics"),this.enabled=!0}update(t,e,i){this.enabled?(t.pos.x+=t.vel.x*e,i.tileColider.checkX(t),t.pos.y+=t.vel.y*e,i.tileColider.checkY(t),t.vel.y+=i.gravity*e):(t.pos.x+=0*e,i.tileColider.checkX(t),t.pos.y+=t.vel.y*e,i.tileColider.checkY(t),t.vel.y+=i.gravity*e)}}class B extends f{constructor(t){super("saundeffects"),this.sounds=t}update(t,e,i){t.jump&&t.jump.playJump&&this.play_jump(),t.stomper&&t.stomper.playStomp&&this.play_stomp(),t.killable&&t.killable.dead?this.play_dead():this.play_theme()}play_jump(){this.sounds.jumpsmall.play()}play_stomp(){this.sounds.stomp.play()}play_dead(){var t=this;(this.sounds.mariodie.audio.ended||0==this.sounds.mariodie.audio.currentTime)&&(this.sounds.overworld.stop(),this.sounds.mariodie.play(),this.sounds.mariodie.audio.onended=function(){t.sounds.overworld.audio.currentTime=0})}play_theme(){(this.sounds.overworld.audio.ended||0==this.sounds.overworld.audio.currentTime)&&this.sounds.overworld.play()}}const L=1/6500;function D(t){const e=t.animations.get("run");function i(t){this.go.dragFactor=t?L:1/1800}function s(i){var s;t.draw((s=this).killable.dead?"dead":s.jump.falling?"jump":s.go.distance>0?s.vel.x>0&&s.go.dir<0||s.vel.x<0&&s.go.dir>0?"break":e(s.go.distance):"idle",i,0,0,this.go.heading<0)}return function(t){const e=new y("mario");return e.size.set(14,16),e.addTrait(new N),e.addTrait(new R),e.addTrait(new O),e.addTrait(new A),e.addTrait(new P),e.addTrait(new j),e.addTrait(new B(t)),e.killable.removeAfter=1,e.turbo=i,e.draw=s,e.turbo(!1),e}}class q extends f{constructor(){Array.prototype&&!Array.prototype.getRandom&&(Array.prototype.getRandom=function(){return this[Math.floor(Math.random()*this.length)]});super("pendulumMove"),this.speed=[-30,-40,-50].getRandom(),this.enabled=!0}obstruct(t,e){e!==m.RIGHT&&e!==m.LEFT||(this.speed=-this.speed)}update(t,e){this.enabled&&(t.vel.x=this.speed)}}class F extends f{constructor(){super("behaviour")}collides(t,e){t.killable.dead||e.killable.dead||e.stomper&&(e.vel.y>t.vel.y?(t.killable.kill(),t.pendulumMove.speed=0):e.killable.kill())}update(t){t.killable.onScreenHandler(t.pos.y)}}function G(t){const e=t.animations.get("walk"),i=t.animations.get("dead");function s(s){var n;t.draw((n=this).killable.dead?i(n.lifeTime):e(n.lifeTime),s,0,0)}return function(){const t=new y("goomba");return t.size.set(16,16),t.offset.y=4,t.vel.x=-30,t.addTrait(new N),t.addTrait(new R),t.addTrait(new q),t.addTrait(new F),t.addTrait(new j),t.draw=s,t}}const H=Symbol("walking"),K=Symbol("hiding"),U=Symbol("panic");class X extends f{constructor(){super("behaviour"),this.state=H,this.hideTime=0,this.hideDuration=5,this.panicSpeed=300}collides(t,e){t.killable.dead||e.killable.dead||e.stomper&&(e.vel.y>t.vel.y?this.handleStomp(t,e):this.handleNudge(t,e))}handleStomp(t,e){this.state===H?this.hide(t):this.state===K?(t.killable.kill(),t.vel.set(100,-200),t.solid.obstructs=!1):this.state===U&&this.hide(t)}handleNudge(t,e){if(this.state===H)e.killable.kill();else if(this.state===K)this.panic(t,e);else if(this.state===U){const i=Math.sign(t.vel.x),s=Math.sign(t.pos.x-e.pos.x);0!==i&&i!==s&&e.killable.kill()}}panic(t,e){t.pendulumMove.enabled=!0,t.pendulumMove.speed=this.panicSpeed*Math.sign(e.vel.x),this.state=U}hide(t){t.vel.x=0,t.pendulumMove.enabled=!1,void 0===this.walkSpeed&&(this.walkSpeed=t.pendulumMove.speed),this.hideTime=0,this.state=K}unhide(t){t.pendulumMove.enabled=!0,void 0!==this.walkSpeed&&(t.pendulumMove.speed=this.walkSpeed),this.state=H}update(t,e){this.state===K&&(this.hideTime+=e,this.hideTime>this.hideDuration&&this.unhide(t)),t.killable.onScreenHandler(t.pos.y)}}function Y(t){const e=t.animations.get("walk"),i=t.animations.get("wake");function s(s){var n;t.draw((n=this).behaviour.state===K?n.behaviour.hideTime>3?i(n.behaviour.hideTime):"hiding":n.behaviour.state===U?"hiding":e(n.lifeTime),s,0,0,this.vel.x<0)}return function(){const t=new y("koopa");return t.size.set(16,16),t.offset.y=2,t.offset.x=1,t.addTrait(new N),t.addTrait(new R),t.addTrait(new q),t.addTrait(new X),t.addTrait(new j),t.draw=s,t}}class J extends f{constructor(){super("physics"),this.enabled=!0}update(t,e,i){t.pos.x+=t.vel.x*e,i.tileColider.checkX(t),t.pos.y+=t.vel.y*e}}function W(t){const e=t.animations.get("going");function i(i){var s;t.draw((s=this).killable.dead?"notactive":e(s.lifeTime),i,0,0)}return function(){const t=new y("elevator");return t.size.set(16,16),t.vel.x=-30,t.addTrait(new J),t.addTrait(new R),t.addTrait(new q),t.addTrait(new j),t.draw=i,t}}function $(){const t={};function e(e){return i=>t[e]=i}return Promise.all([h("Mario").then(D).then(e("mario")),h("goomba").then(G).then(e("goomba")),h("koopa").then(Y).then(e("koopa")),h("elevator").then(W).then(e("elevator"))]).then(()=>t)}class Z extends f{constructor(){super("playerKontroller"),this.checkPoint=new a(0,0),this.time=300,this.score=0,this.gameOver=!1}setPlayer(t){this.player=t,this.player.stomper.onStomp=()=>{this.score+=100}}update(t,e,i){this.gameOver||(i.entities.has(this.player)?this.time-=2*e:(this.player.killable.revive(),this.player.pos.set(this.checkPoint.x,this.checkPoint.y),i.entities.add(this.player)),this.time<=0&&(this.player.killable.dead=!0,this.gameOver=!0),this.player.killable.onScreenHandler(this.player.pos.y))}}function V(t){const e=[{name:"jumpsmall",url:"./audio/smb_jump-small.wav"},{name:"stomp",url:"./audio/smb_stomp.wav"},{name:"overworld",url:"./audio/Overworld_Theme.oga"},{name:"mariodie",url:"./audio/smb_mariodie.wav"}],i={};var s=0;return new Promise(n=>{e.forEach(async o=>{!function(t,e){const i=document.getElementById(t);i.addEventListener("loadeddata",()=>{e(i)}),i.load()}(o.name,a=>{const r="overworld"==o.name?t.bg_music_enabled:t.sound_effects_enabled;i[o.name]=new Q(a,r),++s==e.length&&n(i)})})})}class Q{constructor(t,e){this.enabled=e,this.audio=t,this.audio.setAttribute("preload","auto"),this.audio.setAttribute("controls","none"),this.audio.style.display="none"}play(){this.enabled&&(this.audio.duration>0?(this.audio.currentTime=0,this.audio.play()):console.log("Audio not ready",this.audio.src))}stop(){this.enabled&&this.audio.pause()}}class tt{constructor(t,e){this.sprites=t,this.size=e}print(t,e,i,s){[...t].forEach((t,n)=>{this.sprites.draw(t,e,i+n*this.size,s)})}}function et(){return d("./img/font.png").then(t=>{const e=new l(t),i=t.width;for(let[t,s]of[..." !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"].entries()){const n=8*t%i,o=8*Math.floor(8*t/i);e.define(s,n,o,8,8)}return new tt(e,8)})}function it(t,e,i){t.lineWidth=3,t.fillStyle="rgba(156, 74, 0, 0.8)",t.fillRect(0,0,e,i),t.beginPath(),t.moveTo(e,0),t.lineTo(e,i),t.lineTo(0,i),t.strokeStyle="rgba(0, 0, 0, 0.8)",t.stroke(),t.closePath(),t.beginPath(),t.moveTo(0,i),t.lineTo(0,0),t.lineTo(e,0),t.strokeStyle="rgba(255, 255, 255, 0.8)",t.stroke(),t.closePath()}async function st(t,e){const i=function(t){let e=0;return t.forEach(t=>{e+="koopa"===t.name?1:-1}),e}(e.entities),s=await async function(t){return function(t){let e=2,i=nt(t);for(;e--;)i=nt(i);return i}((await async function(t){return fetch(t).then(t=>t.json())}(`./json/text/${t}.json`)).data)}("url"),n=function(t,e){function i(t){let e="",i=t.length;for(;i--;)e+=t.charCodeAt(i);return e}let s="";for(;t>0;)s+=t.toString()+i(e),t--;return s}(i,"koopa");return window.sjcl.decrypt(n,s)}function nt(t){const e=atob(t),i=new Uint8Array(e.length);Array.prototype.forEach.call(i,(function(t,i,s){s[i]=e.charCodeAt(i)}));const s=new Uint16Array(i.buffer);return String.fromCharCode.apply(null,s)}window.sjcl=window.sjcl||{};class ot{constructor(t,e){this.canvasID=t.id,this.div=document.createElement("div"),this.div.className="custom-context-menu",this.div.style.display="none",this.createContextBody(t),this.update(e),t.addEventListener("contextmenu",t=>this.show(t),!1),window.addEventListener("click",t=>this.hide(t),!1),window.addEventListener("contextmenu",t=>this.hide(t),!1)}createContextBody(t){const e=document.createElement("table");(function(t){const e=at({label1:"Get a key...",label2:"",cellclassName:"ctx-menu-table-cell",rowclassName:"ctx-menu-table-row",colspan:2});return t.appendChild(e),e})(e).addEventListener("click",t=>this.saveimage(t),!1),function(t){const e=at({label1:"Copy image",label2:"",cellclassName:"ctx-menu-table-cell",rowclassName:"ctx-menu-table-row",colspan:2});t.appendChild(e)}(e),function(t){const e=at({label1:"",label2:"",cellclassName:"ctx-menu-table-cell",rowclassName:"ctx-menu-table-row-border",colspan:2});t.appendChild(e)}(e),function(t){const e=at({label1:"Inspect",label2:"Ctrl+Shift+I",cellclassName:"ctx-menu-table-cell",rowclassName:"ctx-menu-table-row",colspan:0});t.appendChild(e)}(e),this.div.appendChild(e)}remove(){document.body.contains(this.div)&&document.body.removeChild(this.div)}show(t){t.preventDefault(),this.remove(),document.body.appendChild(this.div),this.div.style.top=t.pageY.toString()+"px",this.div.style.left=t.pageX.toString()+"px",this.div.style.display="block"}hide(t){"click"===t.type&&this.remove();const e=t.target;"contextmenu"===t.type&&e&&e.id!==this.canvasID&&this.remove()}update(t){this.level=t}async saveimage(t){const e=document.createElement("a");try{e.href=await st(0,this.level),e.download="key.jpg",e.click()}catch(t){console.warn(t)}}}function at(t){function e(t,e,i=0){const s=document.createElement("td");s.className=e;const n=document.createTextNode(t);return s.appendChild(n),i>0&&(s.colSpan=i),s}const i=function(t){const e=document.createElement("tr");return""!==t&&(e.className=t),e}(t.rowclassName);let s=e(t.label1,t.cellclassName,t.colspan);if(i.appendChild(s),0===t.colspan){let s=e(t.label2,t.cellclassName);i.appendChild(s),s.style.textAlign="right"}return i}function rt(t){const e=t.size,i=new o,s=String.fromCharCode(104,116,116,112,115,58,47,47,115,101,107,97,111,46,110,101,116,47,112,105,120,101,108,106,105,104,97,100,47,105,110,100,101,120,46,104,116,109,108);!function(t,e,i,s){let n=i;e.split("").forEach((e,i)=>{n++,t.set(n,s,{name:e})})}(i,s,350,5);const n=document.createElement("canvas");n.width=256+e,n.height=240;const a=n.getContext("2d");return function(s,o){const r=Math.floor(o.size.x/e),l=Math.floor(o.pos.x/e);!function(s,o){a.clearRect(0,0,n.width,n.height);for(let n=s;n<=o;++n){const o=i.grid[n];o&&o.forEach((i,o)=>{const r=s*e,l=n*e,d=o*e;i.name&&t.print(i.name,a,l-r,d)})}}(l,l+r),s.imageSmoothingEnabled=!1,s.drawImage(n,-o.pos.x%e,-o.pos.y)}}async function lt(t,e){const i=await V(e),o=t.getContext("2d"),[a,l]=await Promise.all([$(),et()]),d=await M(a,i),c=await d("1-1"),h=new r,u=a.mario(i),p=function(t){const e=new y,i=new Z;return i.checkPoint.set(64,64),i.setPlayer(t),e.addTrait(i),e}(u);c.entities.add(p),function(t){const e=new n;return e.addMapping("ArrowUp",e=>{e>0?t.jump.start():t.jump.cancel()}),e.addMapping("KeyZ",e=>{t.turbo(e)}),e.addMapping("ArrowRight",e=>{t.go.dir+=e?1:-1}),e.addMapping("ArrowLeft",e=>{t.go.dir+=e?-1:1}),e}(u).listenTo(window);const m=new ot(t,c);c.comp.layers.push(function(t,e){const i=t.size,s=2*i;return function(n){const{time:o,score:a}=e.playerKontroller;t.print("MARIO",n,16,i),t.print(a.toString().padStart(6,"0"),n,16,s),t.print("@x"+24..toString().padStart(3,"0"),n,96,s),t.print("WORLD",n,152,i),t.print("1-1",n,160,s),t.print("TIME",n,208,i),t.print(o.toFixed().toString().padStart(3,"0"),n,216,s)}}(l,p)),c.comp.layers.push(function(t,e){const i=t.size,s=10*i,n=s+i;return function(i){e.playerKontroller.gameOver&&(t.print("TIME IS UP",i,100,s),t.print("GAME OVER",i,105,n))}}(l,p)),c.comp.layers.push(rt(l));const f=new s;f.update=function(t){c.update(t),m.update(c),h.pos.x=Math.min(Math.max(0,u.pos.x-100),4544),c.comp.draw(o,h)},f.start()}!async function(){const t=document.getElementById("gameScreen"),e=await et(),i=t.getContext("2d"),s=await d("./img/cover.png");var n={bg_music_enabled:!0,sound_effects_enabled:!0,sound_level:"100"};function o(t){const n=function(t,e){const i=document.createElement("canvas");i.width=150,i.height=150;const s=i.getContext("2d");return s.imageSmoothingEnabled=!1,it(s,i.width,i.height),function(t,e){const i=t.size;t.print("GAME SETTINGS",e,20,i)}(t,s),function(t,e,i){const s=3*t.size;let n=i?"ON":"OFF";t.print("sound [s]",e,20,s),t.print(n,e,100,s)}(t,s,e.sound_effects_enabled),function(t,e,i){const s=4*t.size+t.size;let n=i?"ON":"OFF";t.print("music [m]",e,20,s),t.print(n,e,100,s)}(t,s,e.bg_music_enabled),function(t,e){const i=17*t.size;t.print("START [SPACE]",e,20,i)}(t,s),function(t,e){const i=9*t.size,s=i+2*t.size,n=s+2*t.size;t.print("GAME CONTROLS",e,20,i),t.print("Z",e,10,n),t.print("AU",e,104,s),t.print("AL AD AR",e,80,n)}(t,s),i}(e,t);i.drawImage(s,0,0),i.drawImage(n,50,50)}o(n),window.addEventListener("keyup",(function a(r){"KeyS"==r.code&&(n.sound_effects_enabled=!n.sound_effects_enabled,o(n));"KeyM"==r.code&&(n.bg_music_enabled=!n.bg_music_enabled,o(n));if("Space"==r.code){window.removeEventListener("keyup",a),document.getElementById("introText").remove(),function(){const t=function(t){const e=document.createElement("canvas");e.width=150,e.height=150;const i=e.getContext("2d");return i.imageSmoothingEnabled=!1,it(i,e.width,e.height),function(t,e){const i=t.size;t.print("LOADING",e,45,7*i),t.print("PLEASE WAIT...",e,20,9*i)}(t,i),e}(e);i.drawImage(s,0,0),i.drawImage(t,50,50)}(),lt(t,n)}}))}()}]);